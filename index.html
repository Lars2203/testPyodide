<!DOCTYPE html>
<html>
<head>
  <title>Interactive Image Processing</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.16/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/scikit-image@0.19.3/dist/skimage.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-8">
    <h1 class="text-3xl font-bold mb-4">Interactive Image Processing</h1>
    <div class="flex justify-center mb-4">
      <img id="processed-image" src="/api/placeholder/600/400" alt="Processed Image" class="max-w-full h-auto rounded-lg">
    </div>
    <div class="mb-4">
      <label for="threshold" class="block font-medium mb-2">Threshold</label>
      <input type="range" id="threshold" min="0" max="255" value="128" class="w-full" oninput="updateImage()">
    </div>
    <div class="mb-4">
      <label for="kernel-size" class="block font-medium mb-2">Kernel Size</label>
      <input type="range" id="kernel-size" min="1" max="15" value="3" class="w-full" oninput="updateImage()">
    </div>
    <script type="module">
      async function updateImage() {
        await loadPyodide();
        const threshold = document.getElementById('threshold').value;
        const kernelSize = document.getElementById('kernel-size').value;
        const image = await loadImage();
        const processedImage = await processImage(image, threshold, kernelSize);
        displayImage(processedImage);
      }

      async function loadPyodide() {
        if (!window.pyodide) {
          window.pyodide = await loadPyodideAndPackages(['scikit-image']);
        }
      }

      async function loadImage() {
        const response = await fetch('/api/image/gray.png');
        const imageData = await response.arrayBuffer();
        return window.pyodide.openImage(imageData);
      }

      async function processImage(image, threshold, kernelSize) {
        await window.pyodide.runPythonAsync(`
          import numpy as np
          from skimage.filters import threshold_otsu
          from skimage.morphology import closing, square

          image = np.array(${image})
          thresh = ${threshold}
          kernel = np.ones((${kernelSize}, ${kernelSize}), dtype=np.uint8)

          binary = image > thresh
          closed = closing(binary, kernel)
          
          ${image}.data = closed.astype(np.uint8).tobytes()
        `);
        return image;
      }

      function displayImage(image) {
        const img = document.getElementById('processed-image');
        img.src = image.toDataURL();
      }

      loadPyodide().then(() => {
        updateImage();
      });
    </script>
  </div>
</body>
</html>