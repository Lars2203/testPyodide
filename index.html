<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Thresholding and Morphological Operations</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
</head>
<body>
    <h1>Image Thresholding and Morphological Operations</h1>

    <label for="threshold-slider">Threshold:</label>
    <input type="range" id="threshold-slider" min="0" max="1" step="0.01" value="0.5">

    <label for="kernel-slider">Kernel Size:</label>
    <input type="range" id="kernel-slider" min="1" max="10" step="1" value="3">

    <label for="operation-switch">Operation:</label>
    <select id="operation-switch">
        <option value="dilation">Dilation</option>
        <option value="erosion">Erosion</option>
    </select>

    <button onclick="applyTransformations()">Apply Transformations</button>

    <h2>Output Image:</h2>
    <canvas id="output-canvas"></canvas>

    <script>
        async function loadPyodideAndPackages() {
            // Load Pyodide and required Python packages
            window.pyodide = await loadPyodide();
            await pyodide.loadPackage(['numpy', 'scikit-image', 'matplotlib']);
        }
        
        async function applyTransformations() {
            const thresholdValue = parseFloat(document.getElementById("threshold-slider").value);
            const kernelSize = parseInt(document.getElementById("kernel-slider").value);
            const operation = document.getElementById("operation-switch").value;

            // Define Python code with Pyodide
            const code = `
from skimage.io import imread
from skimage.color import rgb2gray
from skimage import morphology
import numpy as np

from pyodide.http import pyfetch
from js import document
import asyncio
from io import BytesIO
import matplotlib.pyplot as plt
import imageio.v3 as iio
import io, base64

# Load the image
response = await pyfetch(url="https://lars2203.github.io/testPyodide/gray.png", method="GET")
img = iio.imread(BytesIO(await response.bytes()), index=None)
gray_img = rgb2gray(img)

def threshold(threshold_value):
    binary_img = gray_img > threshold_value
    return binary_img

def morphological_operation(operation, size):
    if operation == "dilation":
        result = morphology.dilation(gray_img, morphology.square(size))
    elif operation == "erosion":
        result = morphology.erosion(gray_img, morphology.square(size))
    return result

# Apply transformations
binary_img = threshold(${thresholdValue})
morphed_img = morphological_operation('${operation}', ${kernelSize})
            `;

            // Run the Python code
            await pyodide.runPythonAsync(code);

            // Get the result image and display it
            const morphedImg = pyodide.globals.get('morphed_img').toJs();
            drawOnCanvas(morphedImg);
        }

        function drawOnCanvas(imageArray) {
            const canvas = document.getElementById("output-canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = imageArray.shape[1];
            canvas.height = imageArray.shape[0];
            
            // Flatten and normalize array for rendering
            const imageData = new Uint8ClampedArray(imageArray.flat().map(v => v * 255));
            const imgData = new ImageData(imageData, canvas.width, canvas.height);
            ctx.putImageData(imgData, 0, 0);
        }

        loadPyodideAndPackages();
    </script>
</body>
</html>
